package_update: true
packages:
  - python3
  - python3-pip
  - docker.io
  - jq

write_files:
  - path: /opt/main.py
    permissions: "0755"
    content: |
      ${main_script}

  - path: /opt/docker_utils.py
    permissions: "0755"
    content: |
      ${docker_script}

  - path: /opt/alert_utils.py
    permissions: "0755"
    content: |
      ${alert_script}

  - path: /opt/system_utils.py
    permissions: "0755"
    content: |
      ${system_script}

  - path: /opt/requirements.txt
    permissions: "0644"
    content: |
      ${requirements}

  - path: /opt/docker-compose.yml
    permissions: "0644"
    content: |
      ${docker_compose}

  - path: /opt/logstash.conf
    permissions: "0644"
    content: |
      ${logstash_pipeline}

  # -------------------------------
  # SYSTEMD SERVICE FIXED PART
  # -------------------------------
  - path: /etc/systemd/system/container-monitor.service
    permissions: "0644"
    owner: root:root
    content: |
      [Unit]
      Description=Container Auto-Heal Monitor
      After=docker.service
      Requires=docker.service

      [Service]
      Type=simple
      ExecStart=/usr/bin/python3 /opt/main.py
      Restart=always
      RestartSec=5
      StartLimitBurst=5
      StartLimitIntervalSec=60
      StandardOutput=syslog
      StandardError=syslog

      [Install]
      WantedBy=multi-user.target

runcmd:
  - mkdir -p /var/log
  - touch /var/log/container-monitor.log
  - chmod 664 /var/log/container-monitor.log

  - systemctl enable docker
  - systemctl start docker

    # Install docker compose plugin
  - apt-get update
  - apt-get install docker-compose-plugin -y

  - pip3 install -r /opt/requirements.txt || true

  # RUN USER APP CONTAINER
  - |
    if [ "${container_image}" != "" ]; then
      echo "Running container ${container_name}"
      docker pull ${container_image}
      docker run -d --name ${container_name} -p ${container_port}:${container_port} ${container_image}
    else
      echo "No application container configured for this VM"
    fi

  # ENABLE MONITOR SERVICE (always enabled)
  - systemctl daemon-reload
  - systemctl enable container-monitor.service
  - systemctl start container-monitor.service

  # START ELK USING DOCKER COMPOSE
  - docker compose -f /opt/docker-compose.yml up -d
